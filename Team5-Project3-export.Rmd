---
title: "Team 5 - Project 3"
author: "Ariba Mandavia, Jose Fuentes, Marco Castro, Steven Gonzalez"
date: "2024-10-14"
output: html_document
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(dbplyr)
library(tidyr)
library(tibble)
library(rvest)
library(rlist)
library(readr)
library(XML)
library(xml2)
library(jsonlite)
library(arrow)
library(stringr)
library(digest)
library(duckdb)
```

## Reading original dataset

```{r init-db-connection}

con <- dbConnect(duckdb::duckdb())

# make an in-memory db and store the connection in a variable

duckdb_register(con, "jobs", read_parquet('datasets/jobs.parquet'))
duckdb_register(con, "skills", read_parquet('datasets/skills_delimned.parquet'))
duckdb_register(con, "job_skills", read_parquet('datasets/job_skills_delimned.parquet'))
duckdb_register(con, "companies",  read_parquet('datasets/companies.parquet'))

# read as df
jobs_df <- tbl(con, "jobs")
skills_df <- tbl(con, "skills")
job_skills_df <- tbl(con, "job_skills")
companies_df <- tbl(con, "companies")

head(jobs_table)

# Joined dataframe
full_df <- dbGetQuery(con,"WITH skills_by_id AS (
                    SELECT job_id,
                      STRING_AGG (skill_name, ',' ) AS skills
                    FROM job_skills AS x
                    LEFT JOIN skills AS s 
                      ON s.skill_id = x.skill_id 
                    GROUP BY job_id
                  )

                  SELECT j.*, c.company, s.skills
                  FROM jobs AS j
                  LEFT JOIN skills_by_id AS s
                      ON s.job_id = j.job_id 
                  LEFT JOIN companies AS c
                    ON c.company_id = j.company_id
            ")

glimpse(full_df)

```

**Data Tidying**



```{r}

# 1. Standardize Column Names
full_df <- full_df %>%
  rename_all(~str_to_lower(.)) %>%    # Convert all column names to lowercase
  rename_all(~str_replace_all(., " ", "_")) # Replace spaces with underscores

# 2. Remove Duplicates
full_df <- full_df %>%
  distinct()  # Keep only unique rows

# 3. Handle Missing Values
# Replace NA values with 'Unknown' in character columns
full_df <- full_df %>%
  mutate(across(where(is.character), ~replace_na(., "Unknown")))

# Display the cleaned data frame
head(full_df)

```


```{r}


# Assuming 'full_df' contains job postings and skill information

# 1. Count the frequency of each skill
skill_counts <- full_df %>%
  count(skill_name, sort = TRUE) %>%  # Count occurrences of each skill and sort by frequency
  rename(frequency = n)  # Rename the count column to 'frequency'

# 2. Display the top skills
head(skill_counts, 10)  # Show the top 10 skills by frequency

```

```{r}
library(ggplot2)

# Plot the top 10 skills
ggplot(skill_counts %>% head(10), aes(x = reorder(skill_name, -frequency), y = frequency)) +
  geom_bar(stat = "identity") +
  labs(title = "Top 10 Skills in Data Science Job Postings",
       x = "Skill",
       y = "Frequency") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

```{r}


# List of text columns to normalize
text_columns <- c("job_title", "job_summary", "job_location", "search_position", "company")

# Apply normalization to each text column
full_df <- full_df %>%
  mutate(across(all_of(text_columns), ~ str_trim(tolower(.))))

# Display the first few rows of the updated dataset
head(full_df)

```


